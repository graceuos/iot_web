<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>ESP32 MQTT IoT Web</title>
  </head>
  <body>
    <h1>ğŸŒ¡ï¸ IoT MQTT ì‹¤ìŠµ í˜ì´ì§€</h1>
    <p>ESP32ê°€ ì „ì†¡í•œ ì˜¨ë„, ìŠµë„ ì •ë³´ë¥¼ MQTTë¡œ ì‹¤ì‹œê°„ í‘œì‹œí•©ë‹ˆë‹¤.</p>

    <p><b>Temperature:</b> <span id="temp">--</span> Â°C</p>
    <p><b>Humidity:</b> <span id="humi">--</span> %</p>

    <hr>
    <p id="status">Connecting to MQTT...</p>

    <!-- MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
      // MQTT ë¸Œë¡œì»¤ ì£¼ì†Œ (WebSocketìš© í¬íŠ¸ 1883)
      const broker = 'wss://damoa.io:1883/mqtt';
      const topic = 'ewha/2567010'; // â† ë³¸ì¸ í•™ë²ˆìœ¼ë¡œ ìˆ˜ì •!

      const client = mqtt.connect(broker);

      // ì—°ê²° ì„±ê³µ ì‹œ
      client.on('connect', function () {
        document.getElementById("status").innerText = "âœ… Connected to MQTT broker";
        client.subscribe(topic);
        console.log("Subscribed to", topic);

        // ì›¹ ì ‘ì† ì‹œ 1íšŒ checkin ë©”ì‹œì§€ ë°œí–‰
        client.publish(topic, 'checkin from web');
      });

      // ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ
      client.on('message', function (topic, message) {
        console.log("Message received:", message.toString());
        try {
          const data = JSON.parse(message.toString());
          document.getElementById("temp").innerText = data.temperature;
          document.getElementById("humi").innerText = data.humidity;
        } catch (e) {
          // JSON í˜•ì‹ì´ ì•„ë‹ ê²½ìš° ê·¸ëŒ€ë¡œ í‘œì‹œ
          document.getElementById("status").innerText = "ğŸ“© " + message.toString();
        }
      });

      client.on('error', function (error) {
        document.getElementById("status").innerText = "âŒ MQTT connection error";
        console.error(error);
      });
    </script>
  </body>
</html>
